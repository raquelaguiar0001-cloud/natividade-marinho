<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio-Lab Master v16.2 - Prote√ß√£o Total</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Orbitron:wght@700&display=swap');
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body { font-family: 'Fredoka', sans-serif; margin: 0; height: 100vh; overflow: hidden; background: radial-gradient(circle, #ffffff 0%, #d0e1f9 100%); color: #1a2a3a; }
        #main-app { display: flex; flex-direction: column; height: 100vh; }
        header { background: white; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 5px solid #00d2ff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 10; }
        .wrapper { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 15px; }
        .sidebar { width: 380px; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
        .panel { background: white; border-radius: 12px; border: 2px solid #00d2ff; overflow: hidden; }
        .panel-header { padding: 10px 15px; background: #f0faff; cursor: pointer; display: flex; justify-content: space-between; font-weight: 700; font-size: 0.75rem; color: #0088aa; }
        .panel-content { padding: 12px; border-top: 1px solid #e0f0f0; }
        .closed .panel-content { display: none; }
        .students-scroll { flex: 1; overflow-y: auto; margin-top: 5px; }
        .student-card { background: white; border-radius: 10px; margin-bottom: 6px; border: 2px solid #eee; padding: 8px; cursor: pointer; }
        .track-container { flex: 1; background: #0b131a; border-radius: 30px; padding: 15px; position: relative; border: 6px solid #fff; overflow-y: auto; }
        body.fullscreen-mode .sidebar, body.fullscreen-mode header { display: none !important; }
        .lane { border-bottom: 1px dashed rgba(255,255,255,0.08); position: relative; display: flex; align-items: center; }
        .runner { position: absolute; transition: 2s; display: flex; align-items: center; gap: 8px; }
        .runner-tag { background: white; padding: 2px 6px; border-radius: 5px; font-weight: 900; border: 2px solid #00d2ff; white-space: nowrap; font-size: 10px; }
        .check-grid { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .check-box { width: 28px; height: 28px; border: 2px solid #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; cursor: pointer; }
        .check-box.active { background: #2ecc71; color: white; border-color: #27ae60; }
        #fs-controls { position: fixed; top: 20px; right: 20px; display: none; background: white; padding: 10px; border-radius: 15px; border: 3px solid #00d2ff; z-index: 1000; gap: 10px; }
        body.fullscreen-mode #fs-controls { display: flex; }
    </style>
</head>
<body>

    <div id="fs-controls">
        <button onclick="changeZoom(5)">‚ûï</button>
        <button onclick="changeZoom(-5)">‚ûñ</button>
        <button onclick="toggleFS()" style="background:red; color:white;">SAIR</button>
    </div>

    <div id="main-app">
        <header>
            <div id="info-turma" style="font-weight:bold; background:#1a2a3a; color:#00d2ff; padding:5px 10px; border-radius:8px;">TURMA: ---</div>
            <div style="text-align:center;">
                <b onclick="editL('sch')" id="disp-sch">ESCOLA</b><br>
                <small onclick="editL('tea')" id="disp-tea">PROFESSOR</small>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="toggleFS()" style="background:#9b59b6; color:white; border:none; padding:8px; border-radius:8px; cursor:pointer;">üì∫ TELA CHEIA</button>
                <button onclick="exportExcel()" style="background:#27ae60; color:white; border:none; padding:8px; border-radius:8px; cursor:pointer;">üìä EXCEL</button>
            </div>
        </header>

        <div class="wrapper">
            <aside class="sidebar">
                <div style="background:#fff; padding:10px; border-radius:12px; border:2px solid #ccc; display:flex; gap:5px;">
                    <button onclick="createBackup()" style="flex:1; font-size:10px;">üíæ SALVAR BACKUP</button>
                    <button onclick="document.getElementById('fileIn').click()" style="flex:1; font-size:10px;">üìÇ ABRIR BACKUP</button>
                    <input type="file" id="fileIn" style="display:none" onchange="restoreBackup(event)">
                </div>

                <div class="panel" id="p-turmas">
                    <div class="panel-header" onclick="this.parentElement.classList.toggle('closed')">üè´ TURMAS E CONFIGS <span>‚Üï</span></div>
                    <div class="panel-content">
                        <div id="class-tabs" style="display:flex; gap:3px; flex-wrap:wrap; margin-bottom:8px;"></div>
                        <input type="text" id="in-cl" placeholder="+ Nova Turma e Enter" onkeypress="if(event.key==='Enter') addC()" style="width:100%; padding:5px;">
                        <div id="subj-tabs" style="display:flex; gap:3px; margin-top:8px;"></div>
                        <input type="text" id="in-sb" placeholder="+ Nova Mat√©ria" onkeypress="if(event.key==='Enter') addS()" style="width:100%; padding:5px; margin-top:5px;">
                        <button onclick="if(confirm('Limpar tudo? Fa√ßa backup antes!')){localStorage.clear(); location.reload();}" style="width:100%; margin-top:10px; font-size:9px; background:#ffeded; color:red; border:1px solid red;">‚ö†Ô∏è LIMPAR SISTEMA (RESET)</button>
                    </div>
                </div>

                <div class="panel closed" id="p-alun">
                    <div class="panel-header" onclick="this.parentElement.classList.toggle('closed')">üë• LISTA DE ALUNOS <span>‚Üï</span></div>
                    <div class="panel-content">
                        <textarea id="in-nm" placeholder="Cole os nomes (um por linha)..." style="width:100%; height:50px;"></textarea>
                        <button onclick="impSt()" style="width:100%; margin-top:5px;">IMPORTAR LISTA</button>
                    </div>
                </div>

                <div id="count-label" style="font-size:11px; font-weight:bold; margin-top:10px;">ALUNOS:</div>
                <div class="students-scroll" id="stu-list"></div>
            </aside>

            <main class="track-container">
                <div id="bim-tabs" style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;"></div>
                <div id="track"></div>
            </main>
        </div>
    </div>

    <script>
        let state = { cs: [], ci: -1, b: 1, zoom: 45 };
        const emojis = ['üöÄ','‚öõÔ∏è','üß¨','üß™','ü™ê','üõ∏','üëæ','üåø','ü¶†','üî≠','üë®‚Äçüî¨','üë©‚Äçüî¨','üåç','‚òÄÔ∏è','üíé','üå°Ô∏è'];

        function load() {
            try {
                const data = localStorage.getItem('biolab_v15');
                if(data) {
                    const parsed = JSON.parse(data);
                    state = Object.assign(state, parsed);
                }
            } catch(e) { console.error("Erro ao carregar dados."); }
            render();
        }

        function save() { localStorage.setItem('biolab_v15', JSON.stringify(state)); }

        function addC() { let v = document.getElementById('in-cl').value; if(v){ state.cs.push({n:v, ss:['Ci√™ncias'], si:0, totA:10, crits:[], st:[]}); state.ci=state.cs.length-1; document.getElementById('in-cl').value=''; save(); render(); }}
        function addS() { let v = document.getElementById('in-sb').value; if(v && state.ci>-1){ state.cs[state.ci].ss.push(v); document.getElementById('in-sb').value=''; save(); render(); }}
        function impSt() {
            let names = document.getElementById('in-nm').value.split('\n').filter(x=>x.trim());
            if(state.ci===-1) return alert("Crie uma turma primeiro!");
            names.forEach(n => state.cs[state.ci].st.push({n:n.trim(), sc:{}, open:false, em:emojis[Math.floor(Math.random()*emojis.length)]}));
            state.cs[state.ci].st.sort((a,b)=>a.n.localeCompare(b.n));
            document.getElementById('in-nm').value=''; save(); render();
        }

        function getScore(stu) {
            const c = state.cs[state.ci]; if(!c) return 0;
            let kA = `${c.si}_${state.b}_ativ`, vists = (stu.sc[kA] || []).length;
            return (vists / (c.totA || 10)) * 10;
        }

        function render() {
            const c = state.cs[state.ci];
            document.getElementById('disp-sch').innerText = localStorage.getItem('sch') || 'ESCOLA';
            document.getElementById('disp-tea').innerText = localStorage.getItem('tea') || 'PROFESSOR';
            
            if(c) {
                document.getElementById('info-turma').innerText = `TURMA: ${c.n}`;
                document.getElementById('count-label').innerText = `ALUNOS: ${c.st.length}`;
                document.getElementById('class-tabs').innerHTML = state.cs.map((x,i)=>`<button onclick="state.ci=${i};render();save();" style="background:${i===state.ci?'#00d2ff':'#eee'}">${x.n}</button>`).join('');
                document.getElementById('subj-tabs').innerHTML = c.ss.map((s,i)=>`<button onclick="state.cs[state.ci].si=${i};render();save();" style="background:${i===c.si?'#2ecc71':'#eee'}">${s}</button>`).join('');
                
                document.getElementById('stu-list').innerHTML = c.st.map((stu, si) => {
                    let kA = `${c.si}_${state.b}_ativ`, chs = '';
                    for(let i=0; i<c.totA; i++) chs += `<div class="check-box ${(stu.sc[kA]||[]).includes(i)?'active':''}" onclick="tglA(${si},'${kA}',${i})">${i+1}</div>`;
                    return `<div class="student-card"><b>${stu.n}</b><div class="check-grid">${chs}</div></div>`;
                }).join('');

                const track = document.getElementById('track'); track.innerHTML = '';
                const z = state.zoom || 45;
                c.st.forEach((stu) => {
                    let g = getScore(stu);
                    let lane = document.createElement('div'); lane.className='lane'; lane.style.height = z + 'px';
                    lane.innerHTML = `<div class="runner" style="left:${g*8.5}%"><div style="font-size:${z*0.7}px">${stu.em}</div><div class="runner-tag">${stu.n} | ${g.toFixed(1)}</div></div>`;
                    track.appendChild(lane);
                });
            }
            document.getElementById('bim-tabs').innerHTML = [1,2,3,4].map(b=>`<button onclick="state.b=${b};render();save();" style="background:${b===state.b?'#00d2ff':'white'}">${b}¬∫ BIM</button>`).join('');
        }

        function tglA(si, k, idx) {
            if(!state.cs[state.ci].st[si].sc[k]) state.cs[state.ci].st[si].sc[k] = [];
            let a = state.cs[state.ci].st[si].sc[k]; let p = a.indexOf(idx);
            if(p > -1) a.splice(p, 1); else a.push(idx);
            save(); render();
        }
        function toggleFS() { document.body.classList.toggle('fullscreen-mode'); render(); }
        function changeZoom(v) { state.zoom = Math.max(20, (state.zoom||45)+v); save(); render(); }
        function editL(k) { let n=prompt("Editar:", localStorage.getItem(k)); if(n){localStorage.setItem(k,n); render();}}
        function createBackup() { let b=new Blob([JSON.stringify({state,sch:localStorage.getItem('sch'),tea:localStorage.getItem('tea')})],{type:'application/json'}); let a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='Backup.json'; a.click(); }
        function restoreBackup(e) { let r=new FileReader(); r.onload=(ev)=>{ let d=JSON.parse(ev.target.result); state=d.state; localStorage.setItem('sch',d.sch); localStorage.setItem('tea',d.tea); save(); render(); }; r.readAsText(e.target.files[0]); }
        function exportExcel() { let csv="ALUNO;NOTA\n"+state.cs[state.ci].st.map(s=>`${s.n};${getScore(s).toFixed(1)}`).join('\n'); window.open('data:text/csv;charset=utf-8,'+escape(csv)); }

        window.onload = load;
    </script>
</body>
</html>
