<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio-Lab Master v16.5 - Seguro e Edit√°vel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Orbitron:wght@700&display=swap');
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body { font-family: 'Fredoka', sans-serif; margin: 0; height: 100vh; overflow: hidden; background: radial-gradient(circle, #ffffff 0%, #d0e1f9 100%); color: #1a2a3a; }
        #main-app { display: flex; flex-direction: column; height: 100vh; }
        header { background: white; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 5px solid #00d2ff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 10; }
        .wrapper { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 15px; }
        .sidebar { width: 380px; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
        .panel { background: white; border-radius: 12px; border: 2px solid #00d2ff; overflow: hidden; }
        .panel-header { padding: 10px 15px; background: #f0faff; cursor: pointer; display: flex; justify-content: space-between; font-weight: 700; font-size: 0.75rem; color: #0088aa; }
        .panel-content { padding: 12px; border-top: 1px solid #e0f0f0; }
        .closed .panel-content { display: none; }
        .students-scroll { flex: 1; overflow-y: auto; margin-top: 5px; }
        .student-card { background: white; border-radius: 10px; margin-bottom: 8px; border: 2px solid #eee; padding: 10px; position: relative; }
        .track-container { flex: 1; background: #0b131a; border-radius: 30px; padding: 15px; position: relative; border: 6px solid #fff; overflow-y: auto; }
        body.fullscreen-mode .sidebar, body.fullscreen-mode header { display: none !important; }
        .lane { border-bottom: 1px dashed rgba(255,255,255,0.08); position: relative; display: flex; align-items: center; }
        .runner { position: absolute; transition: 2s; display: flex; align-items: center; gap: 8px; }
        .runner-tag { background: white; padding: 2px 6px; border-radius: 5px; font-weight: 900; border: 2px solid #00d2ff; white-space: nowrap; font-size: 10px; }
        .check-grid { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .check-box { width: 28px; height: 28px; border: 2px solid #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; cursor: pointer; background: white; }
        .check-box.active { background: #2ecc71; color: white; border-color: #27ae60; }
        #fs-controls { position: fixed; top: 20px; right: 20px; display: none; background: white; padding: 10px; border-radius: 15px; border: 3px solid #00d2ff; z-index: 1000; gap: 10px; }
        body.fullscreen-mode #fs-controls { display: flex; }
        .btn-edit { background: #f1c40f; color: black; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .btn-del { background: #e74c3c; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="fs-controls">
        <button onclick="changeZoom(5)">‚ûï</button>
        <button onclick="changeZoom(-5)">‚ûñ</button>
        <button onclick="toggleFS()" style="background:red; color:white; border:none; padding:5px 15px; border-radius:8px; cursor:pointer;">SAIR</button>
    </div>

    <div id="main-app">
        <header>
            <div id="info-turma" style="font-weight:bold; background:#1a2a3a; color:#00d2ff; padding:5px 10px; border-radius:8px;">TURMA: ---</div>
            <div style="text-align:center;">
                <b onclick="editL('sch')" id="disp-sch">ESCOLA</b><br>
                <small onclick="editL('tea')" id="disp-tea">PROFESSOR</small>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="toggleFS()" style="background:#9b59b6; color:white; border:none; padding:8px; border-radius:8px; cursor:pointer;">üì∫ TELA CHEIA</button>
                <button onclick="exportExcel()" style="background:#27ae60; color:white; border:none; padding:8px; border-radius:8px; cursor:pointer;">üìä EXCEL</button>
            </div>
        </header>

        <div class="wrapper">
            <aside class="sidebar">
                <div style="background:#fff; padding:10px; border-radius:12px; border:2px solid #ccc; display:flex; gap:5px;">
                    <button onclick="createBackup()" style="flex:1; font-size:10px; cursor:pointer;">üíæ SALVAR BACKUP</button>
                    <button onclick="document.getElementById('fileIn').click()" style="flex:1; font-size:10px; cursor:pointer;">üìÇ ABRIR BACKUP</button>
                    <input type="file" id="fileIn" style="display:none" onchange="restoreBackup(event)">
                </div>

                <div class="panel" id="p-turmas">
                    <div class="panel-header" onclick="this.parentElement.classList.toggle('closed')">üè´ TURMAS E MAT√âRIAS <span>‚Üï</span></div>
                    <div class="panel-content">
                        <div id="class-tabs" style="display:flex; gap:3px; flex-wrap:wrap; margin-bottom:8px;"></div>
                        <input type="text" id="in-cl" placeholder="+ Turma e Enter" onkeypress="if(event.key==='Enter') addC()" style="width:100%; padding:5px;">
                        <div id="subj-tabs" style="display:flex; gap:3px; margin-top:8px; flex-wrap:wrap;"></div>
                        <input type="text" id="in-sb" placeholder="+ Mat√©ria e Enter" onkeypress="if(event.key==='Enter') addS()" style="width:100%; padding:5px; margin-top:5px;">
                    </div>
                </div>

                <div class="panel closed" id="p-crit">
                    <div class="panel-header" onclick="this.parentElement.classList.toggle('closed')">üìã CRIT√âRIOS DE NOTA <span>‚Üï</span></div>
                    <div class="panel-content">
                        Vistos (Total): <input type="number" id="tot-at" value="10" onchange="upTot(this.value)" style="width:50px; margin-bottom:10px;"><br>
                        <strong>Outros Crit√©rios:</strong>
                        <div id="crit-list" style="margin:8px 0;"></div>
                        <input type="text" id="in-cr" placeholder="Ex: Prova, Trabalho..." style="width:70%; padding:5px;">
                        <button onclick="addCrit()" style="cursor:pointer;">+</button>
                    </div>
                </div>

                <div class="panel closed" id="p-alun">
                    <div class="panel-header" onclick="this.parentElement.classList.toggle('closed')">üë• IMPORTAR ALUNOS <span>‚Üï</span></div>
                    <div class="panel-content">
                        <textarea id="in-nm" placeholder="Nomes (um por linha)..." style="width:100%; height:50px;"></textarea>
                        <button onclick="impSt()" style="width:100%; margin-top:5px; cursor:pointer;">IMPORTAR</button>
                    </div>
                </div>

                <div id="count-label" style="font-size:11px; font-weight:bold; margin-top:10px;">ALUNOS:</div>
                <div class="students-scroll" id="stu-list"></div>
            </aside>

            <main class="track-container">
                <div id="bim-tabs" style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;"></div>
                <div id="track"></div>
            </main>
        </div>
    </div>

    <script>
        let state = { cs: [], ci: -1, b: 1, zoom: 45 };
        const emojis = ['üöÄ','‚öõÔ∏è','üß¨','üß™','ü™ê','üõ∏','üëæ','üåø','ü¶†','üî≠','üë®‚Äçüî¨','üë©‚Äçüî¨','üåç','‚òÄÔ∏è','üíé','üå°Ô∏è'];

        function load() {
            try {
                const data = localStorage.getItem('biolab_v15');
                if(data) state = Object.assign(state, JSON.parse(data));
            } catch(e) {}
            render();
        }

        function save() { localStorage.setItem('biolab_v15', JSON.stringify(state)); }

        function addC() { let v=document.getElementById('in-cl').value; if(v){ state.cs.push({n:v, ss:['Ci√™ncias'], si:0, totA:10, crits:[], st:[]}); state.ci=state.cs.length-1; document.getElementById('in-cl').value=''; save(); render(); }}
        function addS() { let v=document.getElementById('in-sb').value; if(v && state.ci>-1){ state.cs[state.ci].ss.push(v); document.getElementById('in-sb').value=''; save(); render(); }}
        function addCrit() { let v=document.getElementById('in-cr').value; if(v && state.ci>-1){ state.cs[state.ci].crits.push({n:v}); document.getElementById('in-cr').value=''; save(); render(); }}
        function upTot(v) { if(state.ci>-1){ state.cs[state.ci].totA=parseInt(v); save(); render(); }}

        function impSt() {
            let names = document.getElementById('in-nm').value.split('\n').filter(x=>x.trim());
            if(state.ci===-1) return alert("Crie uma turma!");
            names.forEach(n => state.cs[state.ci].st.push({n:n.trim(), sc:{}, em:emojis[Math.floor(Math.random()*emojis.length)]}));
            state.cs[state.ci].st.sort((a,b)=>a.n.localeCompare(b.n));
            document.getElementById('in-nm').value=''; save(); render();
        }

        function editStu(si) {
            let n = prompt("Editar nome do aluno:", state.cs[state.ci].st[si].n);
            if(n && n.trim() !== "") { state.cs[state.ci].st[si].n = n.trim(); save(); render(); }
        }

        function delStu(si) {
            if(confirm("Tem certeza que deseja excluir este aluno?")) { state.cs[state.ci].st.splice(si,1); save(); render(); }
        }

        function getScore(stu) {
            const c = state.cs[state.ci]; if(!c) return 0;
            let sum = 0, kA = `${c.si}_${state.b}_ativ`;
            sum += ( (stu.sc[kA] || []).length / (c.totA || 10) ) * 10;
            c.crits.forEach(cr => sum += parseFloat(stu.sc[`${c.si}_${state.b}_${cr.n}`] || 0));
            return sum / (c.crits.length + 1);
        }

        function render() {
            const c = state.cs[state.ci];
            document.getElementById('disp-sch').innerText = localStorage.getItem('sch') || 'ESCOLA';
            document.getElementById('disp-tea').innerText = localStorage.getItem('tea') || 'PROFESSOR';
            
            if(c) {
                document.getElementById('info-turma').innerText = `TURMA: ${c.n}`;
                document.getElementById('count-label').innerText = `ALUNOS: ${c.st.length}`;
                document.getElementById('tot-at').value = c.totA;
                document.getElementById('class-tabs').innerHTML = state.cs.map((x,i)=>`<button onclick="state.ci=${i};render();save();" style="background:${i===state.ci?'#00d2ff':'#eee'}; border:none; border-radius:4px; padding:3px 8px; cursor:pointer; font-weight:bold; font-size:10px;">${x.n}</button>`).join('');
                document.getElementById('subj-tabs').innerHTML = c.ss.map((s,i)=>`<button onclick="state.cs[state.ci].si=${i};render();save();" style="background:${i===c.si?'#2ecc71':'#eee'}; border:none; border-radius:4px; padding:3px 8px; cursor:pointer; color:${i===c.si?'white':'black'}; font-size:10px;">${s}</button>`).join('');
                document.getElementById('crit-list').innerHTML = c.crits.map((cr,i)=>`<div style="font-size:12px; margin-bottom:4px;">üß™ ${cr.n} <span onclick="state.cs[state.ci].crits.splice(${i},1);save();render();" style="color:red;cursor:pointer;font-weight:bold;">[‚úñ]</span></div>`).join('');
                
                document.getElementById('stu-list').innerHTML = c.st.map((stu, si) => {
                    let kA = `${c.si}_${state.b}_ativ`, chs = '';
                    for(let i=0; i<c.totA; i++) chs += `<div class="check-box ${(stu.sc[kA]||[]).includes(i)?'active':''}" onclick="tglA(${si},'${kA}',${i})">${i+1}</div>`;
                    let critsHTML = c.crits.map(cr => {
                        let k = `${c.si}_${state.b}_${cr.n}`;
                        return `<div style="font-size:11px; margin-top:6px;">${cr.n}: <input type="number" value="${stu.sc[k]||0}" onchange="upSc(${si},'${k}',this.value)" style="width:45px; border-radius:4px; border:1px solid #ccc;"></div>`;
                    }).join('');
                    return `<div class="student-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <b style="font-size:14px;">${stu.n}</b>
                            <div style="display:flex; gap:4px;">
                                <button class="btn-edit" onclick="editStu(${si})">‚úé</button>
                                <button class="btn-del" onclick="delStu(${si})">üóë</button>
                            </div>
                        </div>
                        <div class="check-grid">${chs}</div>${critsHTML}
                    </div>`;
                }).join('');

                const track = document.getElementById('track'); track.innerHTML = '';
                const z = state.zoom || 45;
                c.st.forEach((stu) => {
                    let g = getScore(stu);
                    let lane = document.createElement('div'); lane.className='lane'; lane.style.height = z + 'px';
                    lane.innerHTML = `<div class="runner" style="left:${g*8.5}%"><div style="font-size:${z*0.7}px; cursor:pointer;" onclick="nextEm(this)">${stu.em}</div><div class="runner-tag">${stu.n} | ${g.toFixed(1)}</div></div>`;
                    track.appendChild(lane);
                });
            }
            document.getElementById('bim-tabs').innerHTML = [1,2,3,4].map(b=>`<button onclick="state.b=${b};render();save();" style="background:${b===state.b?'#00d2ff':'white'}; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.1);">${b}¬∫ BIM</button>`).join('');
        }

        function tglA(si, k, idx) {
            if(!state.cs[state.ci].st[si].sc[k]) state.cs[state.ci].st[si].sc[k] = [];
            let a = state.cs[state.ci].st[si].sc[k]; let p = a.indexOf(idx);
            if(p > -1) a.splice(p, 1); else a.push(idx);
            save(); render();
        }
        function upSc(si, k, v) { state.cs[state.ci].st[si].sc[k] = parseFloat(v); save(); render(); }
        function toggleFS() { document.body.classList.toggle('fullscreen-mode'); render(); }
        function changeZoom(v) { state.zoom = Math.max(20, (state.zoom||45)+v); save(); render(); }
        function editL(k) { let n=prompt("Editar informa√ß√£o:", localStorage.getItem(k)); if(n){localStorage.setItem(k,n); render();}}
        function createBackup() { let b=new Blob([JSON.stringify({state,sch:localStorage.getItem('sch'),tea:localStorage.getItem('tea')})],{type:'application/json'}); let a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='Backup_Biolab.json'; a.click(); }
        function restoreBackup(e) { let r=new FileReader(); r.onload=(ev)=>{ try { let d=JSON.parse(ev.target.result); state=d.state; localStorage.setItem('sch',d.sch); localStorage.setItem('tea',d.tea); save(); render(); alert("Dados restaurados!"); } catch(err) { alert("Erro ao ler backup."); } }; r.readAsText(e.target.files[0]); }
        function exportExcel() { 
            let csv = "ALUNO;NOTA\n" + state.cs[state.ci].st.map(s => `${s.n};${getScore(s).toFixed(1)}`).join('\n');
            let blob = new Blob(["\ufeff"+csv], {type: 'text/csv;charset=utf-8;'});
            let url = URL.createObjectURL(blob); let a = document.createElement('a'); a.href = url; a.download = 'Relatorio_Notas.csv'; a.click();
        }
        function nextEm(el) { let cur = emojis.indexOf(el.innerText); el.innerText = emojis[(cur + 1) % emojis.length]; }

        window.onload = load;
    </script>
</body>
</html>
